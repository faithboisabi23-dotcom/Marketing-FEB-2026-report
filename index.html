<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Doctor Referral Performance – February 2026</title>
    <link rel="stylesheet" href="./style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>

<body>
    <header class="hero">
        <div class="container hero-content">
            <div>
                <h1>Doctor Referral Performance – February 1–14, 2026</h1>
                <p>Full dataset</p>
            </div>
            <img class="logo" src="./assets/sonar-logo.png" alt="Sonar logo" />
        </div>
    </header>

    <main class="container">
        <section class="exec-summary">
            <h2>Executive Summary</h2>
            <div class="summary-card">
                <div class="summary-grid">
                    <div>
                        <h4>Total Patients</h4>
                        <p id="summaryTotalPatients">0</p>
                    </div>
                    <div>
                        <h4>Total Referring Doctors</h4>
                        <p id="summaryDoctors">0</p>
                    </div>
                    <div>
                        <h4>% Patients from &gt;5 Referrals</h4>
                        <p id="summaryPctHigh">0%</p>
                    </div>
                    <div>
                        <h4>% Doctors with &gt;5 Referrals</h4>
                        <p id="summaryPareto">0%</p>
                    </div>
                </div>
                <p class="insight insight--summary" id="summaryInsight"></p>
            </div>
        </section>

        <section class="kpi-section">
            <h2>KPI Overview</h2>
            <div class="kpis">
                <div class="kpi">
                    <h3>Number of Patients</h3>
                    <p id="kpiTotalPatients">0</p>
                </div>
                <div class="kpi">
                    <h3>Number of Referring Doctors</h3>
                    <p id="kpiTotalDoctors">0</p>
                </div>
                <div class="kpi">
                    <h3>Total Patients</h3>
                    <p id="kpiTotalPatientsDuplicate">0</p>
                </div>
            </div>
            <div class="kpis kpis--small">
                <div class="kpi kpi--small">
                    <h3>Total Duplicate Patient Records</h3>
                    <p id="kpiDuplicateRecords">0</p>
                </div>
                <div class="kpi kpi--small">
                    <h3>% Duplicate Patients</h3>
                    <p id="kpiDuplicatePct">0%</p>
                </div>
                <div class="kpi kpi--small">
                    <h3>% Doctors with Duplicate Patients</h3>
                    <p id="kpiDoctorDuplicatePct">0%</p>
                </div>
            </div>
        </section>

        <section>
            <h2>Doctors with More Than 5 Referrals</h2>
            <div class="chart-wrap">
                <canvas id="doctorChart" class="chart"></canvas>
            </div>
            <p class="insight">Insight: Referral activity is concentrated within a limited number of doctors, with this
                group accounting for a significant share of total patient volume.</p>
        </section>

        <section>
            <h2>Doctors with 5 or Fewer Referrals</h2>
            <p class="insight">Insight: The majority of referring doctors contribute low referral volumes, indicating a
                broad but shallow distribution of referral activity across the network.</p>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Referring Doctor</th>
                            <th>Patients (Total Rows)</th>
                            <th>Share of Total (%)</th>
                            <th>MRI %</th>
                            <th>CT %</th>
                            <th>XRAY %</th>
                            <th>Ultrasound %</th>
                        </tr>
                    </thead>
                    <tbody id="lowTableBody"></tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">Generated for GitHub Pages</div>
    </footer>

    <script src="./data/doctor_referrals_with_revenue.js"></script>
    <script>
        const formatNumber = (n) => Number(n || 0).toLocaleString();
        const formatMarketer = (m) => (m && m.trim()) ? m.trim() : '';
        const formatShare = (count, total) => {
            const pct = total ? (count / total) * 100 : 0;
            return `${pct.toFixed(1)}%`;
        };
        const modalityCols = ["mri", "ct", "xray", "ultrasound"];
        const formatModalityCells = (mods, total) => {
            const m = mods || {};
            return modalityCols.map((key) => {
                const pct = m[`${key}_pct`] ?? 0;
                return `<td>${Number.isFinite(pct) ? pct.toFixed(1) + '%' : '0.0%'}</td>`;
            }).join('');
        };
        const formatModalityCellsFromCounts = (counts, total) => {
            return modalityCols.map((key) => {
                const cnt = counts[key] || 0;
                const pct = total ? (cnt / total) * 100 : 0;
                return `<td>${pct.toFixed(1)}%</td>`;
            }).join('');
        };
        const sumModalities = (rows) => {
            const sums = { mri: 0, ct: 0, xray: 0, ultrasound: 0 };
            rows.forEach((r) => {
                const mods = r.modalities || {};
                modalityCols.forEach((key) => {
                    const c = mods[`${key}_count`] || 0;
                    sums[key] += c;
                });
            });
            return sums;
        };
        const labelWithMarketer = (doctor, marketer) => {
            const mk = formatMarketer(marketer);
            return mk ? `${doctor} — ${mk}` : doctor;
        };
        const mainHospital = (name = '') => {
            const cleaned = (name || '')
                .replace(/[\u2013\u2014]/g, '-') // normalize en/em dash
                .replace(/\s*-\s*/g, ' - ')
                .replace(/\s+/g, ' ')
                .trim();
            const base = cleaned.split(' - ')[0].trim();
            // Strip parenthetical suffixes like (KNH)
            let canonical = base.replace(/\(.*?\)/g, '').replace(/\s+/g, ' ').trim();
            // Remove trailing KNH tag variants
            canonical = canonical.replace(/\s*KNH\s*$/i, '').trim() || canonical;
            // Collapse repeated text (e.g., duplicated names)
            const repeatMatch = canonical.match(/^(.+?)\1+$/);
            canonical = (repeatMatch ? repeatMatch[1] : canonical).trim();
            const upper = canonical.toUpperCase();
            const anchors = [
                'NAIROBI SPINE',
                'KENYATTA NATIONAL HOSPITAL',
                'AGA KHAN UNIVERSITY HOSPITAL',
                'COPTIC HOSPITAL',
                'THE NAIROBI HOSPITAL',
                'EQUITY AFIA',
                'MP SHAH HOSPITAL',
                'MP SHA HOSPITAL',
                'MIRAZI'
            ];
            for (const anchor of anchors) {
                if (upper.includes(anchor)) return anchor;
            }
            return upper;
        };

        const loadData = async () => {
            // Always use embedded JS payload to avoid file:// and GitHub Pages path issues
            if (window.doctorRevenueData) return window.doctorRevenueData;
            return { high: [], low: [], totals: {} };
        };

        loadData().then((data) => {
            const high = data.high || [];
            const low = data.low || [];
            const totals = data.totals || {};

            const totalPatients = totals.patients || 0;
            const totalDoctors = (totals.doctors_high || 0) + (totals.doctors_low || 0);
            const highPatients = totals.high_patients || 0;
            const pctHigh = totalPatients ? (highPatients / totalPatients) * 100 : 0;
            const pctHighDoctors = totalDoctors ? (totals.doctors_high || 0) / totalDoctors * 100 : 0;
            const duplicatePatients = totals.duplicate_patients || 0;
            const duplicatePatientsPct = totals.duplicate_patients_pct || 0;
            const duplicateDoctorsPct = totals.doctors_with_duplicates_pct || 0;

            // Summary
            document.getElementById('summaryTotalPatients').textContent = formatNumber(totalPatients);
            document.getElementById('summaryDoctors').textContent = formatNumber(totalDoctors);
            document.getElementById('summaryPctHigh').textContent = `${pctHigh.toFixed(1)}%`;
            document.getElementById('summaryPareto').textContent = `${pctHighDoctors.toFixed(1)}%`;
            document.getElementById('summaryInsight').textContent = `${pctHighDoctors.toFixed(1)}% of referring doctors generated more than five referrals and contributed ${pctHigh.toFixed(1)}% of total patient volume.`;

            // KPI
            document.getElementById('kpiTotalPatients').textContent = formatNumber(totalPatients);
            document.getElementById('kpiTotalDoctors').textContent = formatNumber(totalDoctors);
            document.getElementById('kpiTotalPatientsDuplicate').textContent = formatNumber(totalPatients);
            document.getElementById('kpiDuplicateRecords').textContent = formatNumber(duplicatePatients);
            document.getElementById('kpiDuplicatePct').textContent = `${duplicatePatientsPct.toFixed(1)}%`;
            document.getElementById('kpiDoctorDuplicatePct').textContent = `${duplicateDoctorsPct.toFixed(1)}%`;

            // High chart with hospital grouping (use >5 set; augment totals with matching low rows)
            const groupHigh = high.reduce((acc, row) => {
                const key = mainHospital(row.doctor);
                if (!acc[key]) acc[key] = { main: key, total: 0, rows: [] };
                acc[key].total += row.patients || 0;
                acc[key].rows.push(row);
                return acc;
            }, {});
            // add low rows only to existing groups to avoid pulling new low-only hospitals into >5 chart
            low.forEach((row) => {
                const key = mainHospital(row.doctor);
                if (groupHigh[key]) {
                    groupHigh[key].total += row.patients || 0;
                    groupHigh[key].rows.push(row);
                }
            });
            const highGroups = Object.values(groupHigh).sort((a, b) => (b.total || 0) - (a.total || 0));
            const labelKeys = highGroups.map((g) => g.main);
            const labels = highGroups.map((g) => `${g.main} (${formatShare(g.total, totalPatients)})`);
            const values = highGroups.map((g) => g.total);
            const canvas = document.getElementById('doctorChart');
            const ctx = canvas.getContext('2d');
            const chartWrap = canvas.closest('.chart-wrap');
            chartWrap.style.height = (labels.length * 26) + 'px';
            const breakdownHost = (() => {
                let el = document.getElementById('highBreakdown');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'highBreakdown';
                    el.className = 'high-breakdown-popup';
                    el.style.display = 'none';
                    document.body.appendChild(el);
                }
                return el;
            })();

            const closeBreakdown = () => {
                breakdownHost.innerHTML = '';
                breakdownHost.style.display = 'none';
                breakdownHost.dataset.active = '';
            };

            document.addEventListener('click', (evt) => {
                if (!breakdownHost.dataset.active) return;
                const withinPopup = breakdownHost.contains(evt.target);
                if (!withinPopup) closeBreakdown();
            });

            document.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape') closeBreakdown();
            });

            const renderHighBreakdown = (main, idx) => {
                const group = groupHigh[main];
                if (!group) return;
                const rows = group.rows
                    .slice()
                    .sort((a, b) => (b.patients || 0) - (a.patients || 0))
                    .map((r) => `
                    <tr>
                        <td>${r.doctor}</td>
                        <td>${formatNumber(r.patients)}</td>
                        <td>${formatShare(r.patients, totalPatients)}</td>
                        ${formatModalityCells(r.modalities, totalPatients)}
                    </tr>`).join('');
                const tableHtml = `
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Referring Doctor</th>
                                    <th>Patients (Total Rows)</th>
                                    <th>Share of Total (%)</th>
                                    <th>MRI %</th>
                                    <th>CT %</th>
                                    <th>XRAY %</th>
                                    <th>Ultrasound %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>`;
                breakdownHost.innerHTML = tableHtml;
                breakdownHost.style.display = 'block';

                const positionPopup = () => {
                    const padding = 12;
                    const gap = 8;
                    const vw = window.innerWidth;
                    const vh = window.innerHeight;
                    const popupRect = breakdownHost.getBoundingClientRect();

                    let anchorRect;
                    // Try to anchor to the clicked bar
                    if (typeof idx === 'number' && highChart) {
                        const meta = highChart.getDatasetMeta(0);
                        const barEl = meta && meta.data && meta.data[idx];
                        if (barEl) {
                            const chart = highChart;
                            const canvasRect = chart.canvas.getBoundingClientRect();
                            anchorRect = {
                                left: canvasRect.left + barEl.x - (barEl.width || 0) / 2,
                                right: canvasRect.left + barEl.x + (barEl.width || 0) / 2,
                                top: canvasRect.top + barEl.y - (barEl.height || 0) / 2,
                                bottom: canvasRect.top + barEl.y + (barEl.height || 0) / 2,
                                width: barEl.width || 0,
                                height: barEl.height || 0,
                            };
                        }
                    }
                    // Fallback to section
                    if (!anchorRect) {
                        anchorRect = chartWrap.closest('section').getBoundingClientRect();
                    }

                    // Horizontally: center on the anchor, clamp to viewport
                    let left = anchorRect.left + (anchorRect.width / 2) - (popupRect.width / 2);
                    left = Math.max(padding, Math.min(left, vw - popupRect.width - padding));

                    // Vertically: prefer just below the bar
                    let top = anchorRect.bottom + gap;
                    // If that would be cut off, place above the bar
                    if (top + popupRect.height > vh - padding) {
                        top = anchorRect.top - popupRect.height - gap;
                    }
                    // Safety clamp
                    if (top < padding) top = padding;

                    breakdownHost.style.position = 'fixed';
                    breakdownHost.style.left = `${left}px`;
                    breakdownHost.style.top = `${top}px`;
                };

                positionPopup();
                requestAnimationFrame(positionPopup);
            };

            const highChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Patients',
                        data: values,
                        backgroundColor: '#2563eb',
                        barThickness: 14,
                        maxBarThickness: 14,
                        categoryPercentage: 1.0,
                        barPercentage: 1.0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (evt, elements) => {
                        // Stop propagation so the document click listener doesn't
                        // immediately close the popup we're about to open
                        if (evt.native) evt.native.stopPropagation();
                        if (!elements.length) return;
                        const idx = elements[0].index;
                        const main = labelKeys[idx];
                        if (breakdownHost.dataset.active === main) {
                            closeBreakdown();
                        } else {
                            renderHighBreakdown(main, idx);
                            breakdownHost.dataset.active = main;
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#0f172a',
                            font: { size: 11, weight: '700' },
                            formatter: (value) => value
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#111827', font: { size: 11 } },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        y: {
                            ticks: {
                                color: '#0f172a',
                                font: {
                                    size: window.innerWidth < 480 ? 9 : window.innerWidth < 600 ? 10 : 12,
                                    weight: '600'
                                },
                                callback: function (value, index) {
                                    const label = this.getLabelForValue(value);
                                    const w = window.innerWidth;
                                    const maxLen = w < 480 ? 18 : w < 600 ? 25 : 200;
                                    return label.length > maxLen ? label.slice(0, maxLen) + '…' : label;
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Low table with hospital grouping & expandable breakdown (skip rows already represented in high groups)
            const lowBody = document.getElementById('lowTableBody');

            const grouped = low.reduce((acc, row) => {
                const key = mainHospital(row.doctor);
                if (groupHigh[key]) return acc; // already covered in >5 group
                if (!acc[key]) acc[key] = { main: key, total: 0, rows: [] };
                acc[key].total += row.patients || 0;
                acc[key].rows.push(row);
                return acc;
            }, {});

            const groups = Object.values(grouped).sort((a, b) => (b.total || 0) - (a.total || 0));

            const buildBreakdownTable = (rows) => {
                const innerRows = rows
                    .sort((a, b) => (b.patients || 0) - (a.patients || 0))
                    .map((r) => `
                        <tr>
                            <td>${r.doctor}</td>
                            <td>${formatNumber(r.patients)}</td>
                            <td>${formatShare(r.patients, totalPatients)}</td>
                            ${formatModalityCells(r.modalities, totalPatients)}
                        </tr>
                    `)
                    .join('');
                return `
                    <table class="nested-table" style="width:100%; border-collapse:collapse; margin-top:8px;">
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:6px 8px;">Referring Doctor</th>
                                <th style="text-align:left; padding:6px 8px;">Patients (Total Rows)</th>
                                <th style="text-align:left; padding:6px 8px;">Share of Total (%)</th>
                                <th style="text-align:left; padding:6px 8px;">MRI %</th>
                                <th style="text-align:left; padding:6px 8px;">CT %</th>
                                <th style="text-align:left; padding:6px 8px;">XRAY %</th>
                                <th style="text-align:left; padding:6px 8px;">Ultrasound %</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${innerRows}
                        </tbody>
                    </table>
                `;
            };

            groups.forEach((group) => {
                const modCounts = sumModalities(group.rows);
                const tr = document.createElement('tr');
                tr.classList.add('group-row');
                tr.dataset.group = group.main;
                tr.innerHTML = `
                    <td><button type="button" class="linklike" aria-expanded="false" style="background:none;border:none;padding:0;color:inherit;cursor:pointer;text-align:left;width:100%">${group.main}</button></td>
                    <td>${formatNumber(group.total)}</td>
                    <td>${formatShare(group.total, totalPatients)}</td>
                    ${formatModalityCellsFromCounts(modCounts, group.total)}
                `;
                lowBody.appendChild(tr);

                const detail = document.createElement('tr');
                detail.classList.add('group-detail');
                detail.dataset.group = group.main;
                detail.style.display = 'none';
                detail.innerHTML = `<td colspan="7">${buildBreakdownTable(group.rows)}</td>`;
                lowBody.appendChild(detail);

                const toggle = tr.querySelector('button');
                toggle.addEventListener('click', () => {
                    const isOpen = detail.style.display === '';
                    detail.style.display = isOpen ? 'none' : '';
                    detail.classList.toggle('highlight', !isOpen);
                    toggle.setAttribute('aria-expanded', String(!isOpen));
                });
            });
        });
    </script>
</body>

</html>
